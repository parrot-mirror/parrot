#
# Makefile.in
#
# $Id$
#

HLLNAME       = jako
BUILD_DIR     = @build_dir@
LOAD_EXT      = @load_ext@
O             = @o@
BIN_DIR       = @bin_dir@
PERLLIB_DIR   = $(shell $(PERL) -V::sitelib:)
DOC_DIR       = @doc_dir@
MANDIR	      = @mandir@

PERL          = @perl@
RM_F          = @rm_f@
JAKOC         = $(PERL) -I lib jakoc
#CONDITIONED_LINE(cygchkdll):SHRPENV  = env PATH="@build_dir@/blib/lib:$(PATH)"
#INVERSE_CONDITIONED_LINE(cygchkdll):SHRPENV  = env LD_RUN_PATH="@build_dir@/blib/lib"
INTERP        = $(SHRPENV) ../../@test_prog@
PBC_TO_EXE    = $(SHRPENV) ../../pbc_to_exe@exe@
BUILD_DIR     = @build_dir@
RECONFIGURE   = $(PERL) @build_dir@/tools/dev/reconfigure.pl
#CONDITIONED_LINE(darwin):
#CONDITIONED_LINE(darwin):# MACOSX_DEPLOYMENT_TARGET must be defined for OS X compilation/linking
#CONDITIONED_LINE(darwin):export MACOSX_DEPLOYMENT_TARGET := @osx_version@

DOCS = README MAINTAINER

.SUFFIXES: .jako .pir

# default target
all: \
    examples/bench.pir      \
    examples/board.pir      \
    examples/euclid.pir     \
    examples/fact.pir       \
    examples/fib.pir        \
    examples/hello.pir      \
    examples/leibniz.pir    \
    examples/life.pir       \
    examples/mandelbrot.pir \
    examples/mandelzoom.pir \
    examples/mops.pir       \
    examples/nci.pir        \
    examples/primes.pir     \
    examples/queens.pir     \
    examples/sub.pir

help :
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "  all  :             Compile the example scripts"
	@echo "                     This is the default."
	@echo "  installable:       Create self-hosting bins and libs."
	@echo "  install:           Install the installable targets and docs."
	@echo "  over:              Clean and build again"
	@echo ""
	@echo "Testing:"
	@echo "  test:              Run the test suite."
	@echo "  test-installable:  Test self-hosting targets."
	@echo "  testclean:         Clean up test results."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleaning up."
	@echo "  realclean:         Removes also files generated by 'Configure.pl'"
	@echo "  distclean:         Removes also anything built, in theory"
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""


# regenerate the Makefile
Makefile: config/makefiles/root.in
	cd $(BUILD_DIR) && $(RECONFIGURE) --step=gen::languages --languages=jako


# Compilation:
.jako.pir:
	$(JAKOC) $< > $@ || (rm -f $@ && false)

examples/bench.pir:      examples/bench.jako      jakoc
examples/board.pir:      examples/board.jako      jakoc
examples/euclid.pir:     examples/euclid.jako     jakoc
examples/fact.pir:       examples/fact.jako       jakoc
examples/fib.pir:        examples/fib.jako        jakoc
examples/hello.pir:      examples/hello.jako      jakoc
examples/leibniz.pir:    examples/leibniz.jako    jakoc
examples/life.pir:       examples/life.jako       jakoc
examples/mandelbrot.pir: examples/mandelbrot.jako jakoc
examples/mandelzoom.pir: examples/mandelzoom.jako jakoc
examples/mops.pir:       examples/mops.jako       jakoc
examples/nci.pir:        examples/nci.jako        jakoc
examples/primes.pir:     examples/primes.jako     jakoc
examples/queens.pir:     examples/queens.jako     jakoc
examples/sub.pir:        examples/sub.jako        jakoc


# Other targets:

clean:
	$(RM_F) "examples/*.pir" "examples/*.list" "t/*.pir"

realclean: clean
	$(RM_F) Makefile


over:
	@$(MAKE) clean
	@$(MAKE) all

test: all
	$(INTERP) examples/bench.pir
	$(INTERP) examples/board.pir
	$(INTERP) examples/euclid.pir
	$(INTERP) examples/fact.pir
	$(INTERP) examples/fib.pir
	$(INTERP) examples/hello.pir
	$(INTERP) examples/leibniz.pir
	$(INTERP) examples/life.pir
	$(INTERP) examples/mandelbrot.pir
	$(INTERP) examples/mandelzoom.pir
	$(INTERP) examples/mops.pir
	$(INTERP) examples/nci.pir
	$(INTERP) examples/primes.pir
	$(INTERP) examples/queens.pir
	$(INTERP) examples/sub.pir

# TODO: rename build_dir. basic run for missing libs
test-installable : installable
	echo "2-1" | ./installable_$(HLLNAME)@exe@

install : installable
	$(CP) jako $(DESTDIR)$(BIN_DIR)/parrot-jako
	$(CP) jakoc $(DESTDIR)$(BIN_DIR)/parrot-jakoc
	$(CP) -R lib/Jako $(DESTDIR)$(PERLLIB_DIR)
	$(POD2MAN) docs/jako.pod > $(DESTDIR)$(MANDIR)/man1/parrot-$(HLLNAME).1
	$(MKPATH) $(DESTDIR)$(DOC_DIR)/languages/$(HLLNAME)
	$(MKPATH) $(DESTDIR)$(DOC_DIR)/languages/$(HLLNAME)/examples
	$(CP) $(DOCS) $(DESTDIR)$(DOC_DIR)/languages/$(HLLNAME)
	$(CP) *.jako $(DESTDIR)$(DOC_DIR)/languages/$(HLLNAME)
	$(CP) examples/*.jako $(DESTDIR)$(DOC_DIR)/languages/$(HLLNAME)/examples

installable : jako jakoc

testclean:

#
# Local variables:
# mode: makefile
# ex: ft=make
# End:
