# #############################################################################
# .NET CLI To PIR Translator
# Copyright (C) Jonathan Worthington 2005, 2007
# #############################################################################
# requires special treatment for: trans_mono_lib_path, trans_class_library
# Configure.pl: generate_makefile

HLLNAME       = dotnet

# BUILD TOOLS AND UTILITIES
# #########################
PERL          = @perl@
RM_F          = @rm_f@
CP            = @cp@
MKPATH        = @mkpath@
POD2MAN       = pod2man
BUILD_DIR     = @build_dir@
MONOLIB       = ${trans_mono_lib_path}
#IF(cygwin):SHRPENV       = env PATH="@build_dir@/blib/lib:$(PATH)"
#ELSIF(not win32):SHRPENV       = env LD_RUN_PATH="@build_dir@/blib/lib"
PARROT        = $(SHRPENV) ../../parrot@exe@
PBCMERGE      = $(SHRPENV) ../../pbc_merge@exe@
PBC_TO_EXE    = $(SHRPENV) ../../pbc_to_exe@exe@
BUILD_DYNPMC  = $(PERL) $(BUILD_DIR)/tools/build/dynpmc.pl
RECONFIGURE   = $(PERL) $(BUILD_DIR)/tools/dev/reconfigure.pl
OPSBUILD      = $(PERL) $(BUILD_DIR)/tools/build/dynoplibs.pl

# FILE EXTENSIONS
# ###############
LOAD_EXT      = @load_ext@
O             = @o@
A             = @a@
EXE           = @exe@


# DIRECTORIES AND FILES
# #####################
BIN_DIR       = @bin_dir@
LIB_DIR       = @lib_dir@
DOC_DIR       = @doc_dir@
MANDIR	      = @mandir@
PARROT_DYNEXT = $(BUILD_DIR)/runtime/parrot/dynext
PARROT_LIB    = $(BUILD_DIR)/runtime/parrot/library
SRM_PATH      = $(BUILD_DIR)/lib/SRM
PMCDIR    = pmc
PMCS      = dotnetassembly dotnetclassmetadata dotnetmethodmetadata \
            dotnetfieldmetadata dotnetparammetadata dotnetsignature \
            dotnetbytecode dotnettyperefmetadata dotnetmemberrefmetadata \
            dotneteh managedpointer dotnetassemblyref int64 uint64
PMC_FILES = pmc/dotnetassembly.pmc pmc/dotnetclassmetadata.pmc \
            pmc/dotnetmethodmetadata.pmc pmc/dotnetfieldmetadata.pmc \
            pmc/dotnetparammetadata.pmc pmc/dotnetsignature.pmc \
            pmc/dotnetbytecode.pmc pmc/dotnettyperefmetadata.pmc \
            pmc/dotnetmemberrefmetadata.pmc pmc/dotneteh.pmc \
            pmc/managedpointer.pmc pmc/dotnetassemblyref.pmc \
            pmc/int64.pmc pmc/uint64.pmc
OPSDIR    = ops
OPSLIB    = dotnet
OPS_FILES = ops/dotnet.ops
TRAN_PIR  = src/translator.pir src/method.pir src/signature.pir src/typeinfo.pir \
            src/field.pir src/exception.pir
TRAN_PBC  = src/translator.pbc src/method.pbc src/signature.pbc src/typeinfo.pbc \
            src/field.pbc src/exception.pbc


# BUILD TARGETS
# #############

build : net2pbc.pbc

all : Makefile pmc/dotnet$(LOAD_EXT) ops/dotnet_ops$(LOAD_EXT) src/it.pbc \
      src/builtins.pbc src/translib.pbc net2pbc.pbc

installable : net2pbc.pbc installable_net2pbc$(EXE)

pmc/dotnet$(LOAD_EXT) : $(PMC_FILES) pmc/structures.h pmc/tableinfo.h
	@cd $(PMCDIR) && $(BUILD_DYNPMC) generate $(PMCS)
	@cd $(PMCDIR) && $(BUILD_DYNPMC) compile $(PMCS)
	@cd $(PMCDIR) && $(BUILD_DYNPMC) linklibs $(PMCS)
	@cd $(PMCDIR) && $(BUILD_DYNPMC) copy "--destination=$(PARROT_DYNEXT)" $(PMCS)

ops/dotnet_ops$(LOAD_EXT) : $(OPS_FILES)
	@cd $(OPSDIR) && $(OPSBUILD) generate $(OPSLIB)
	@cd $(OPSDIR) && $(OPSBUILD) compile $(OPSLIB)
	@cd $(OPSDIR) && $(OPSBUILD) linklibs $(OPSLIB)
	@cd $(OPSDIR) && $(OPSBUILD) copy "--destination=$(PARROT_DYNEXT)" $(OPSLIB)

src/it.pbc : src/it.pir
	$(PARROT) -o src/it.pbc src/it.pir

src/it.pir : src/translation.rules $(SRM_PATH)/translator.pl config/N2PConfig.pm
	$(PERL) $(SRM_PATH)/translator.pl src/translation.rules --srm ${srm} \
	  --output src/it.pir --config N2PConfig

src/builtins.pbc : src/builtins.pir
	$(PARROT) -o src/builtins.pbc src/builtins.pir

src/builtins.pir : src/internal.methods build/builtins.pl
	$(PERL) build/builtins.pl src/internal.methods --output src/builtins.pir

src/translib.pbc : src/it.pbc src/builtins.pbc $(TRAN_PBC)
	$(PBCMERGE) -o src/translib.pbc $(TRAN_PBC) src/it.pbc src/builtins.pbc

net2pbc.pbc : pmc/dotnet$(LOAD_EXT) src/translib.pbc src/net2pbc.pbc
	$(PBCMERGE) -o net2pbc.pbc src/net2pbc.pbc src/translib.pbc

class-library : net2pbc.pbc
	${trans_class_library}

# regenerate the Makefile
Makefile: config/Makefile.in
	$(PERL) Configure.pl

net2pbc$(EXE) : net2pbc.pbc
	$(PBC_TO_EXE) net2pbc.pbc

installable_net2pbc$(EXE) : net2pbc.pbc
	$(PBC_TO_EXE) net2pbc.pbc --install


# PER FILE RULES AND DEPENDENCIES
# ###############################

src/net2pbc.pbc : src/net2pbc.pir
	$(PARROT) -o src/net2pbc.pbc src/net2pbc.pir

src/translator.pbc : src/translator.pir
	$(PARROT) -o src/translator.pbc src/translator.pir

src/method.pbc : src/method.pir
	$(PARROT) -o src/method.pbc src/method.pir

src/signature.pbc : src/signature.pir
	$(PARROT) -o src/signature.pbc src/signature.pir

src/typeinfo.pbc : src/typeinfo.pir
	$(PARROT) -o src/typeinfo.pbc src/typeinfo.pir

src/field.pbc : src/field.pir
	$(PARROT) -o src/field.pbc src/field.pir

src/exception.pbc : src/exception.pir
	$(PARROT) -o src/exception.pbc src/exception.pir

$(TRAN_PIR) :

src/translation.rules : 


# TEST TARGETS
# ############

test : all
	$(PERL) -It t/harness

# TODO: rename build_dir. basic run for missing libs
installable_test : installable
	./installable_net2pbc$(EXE)

install : all installable
	$(CP) installable_net2pbc$(EXE) $(DESTDIR)$(BIN_DIR)/parrot-net2pbc$(EXE)
	@cd $(OPSDIR) && $(OPSBUILD) copy "--destination=$(DESTDIR)$(LIB_DIR)/parrot/dynext" $(OPSLIB)
	@cd $(PMCDIR) && $(BUILD_DYNPMC) copy "--destination=$(DESTDIR)$(LIB_DIR)/parrot/dynext" $(PMCS)
	$(POD2MAN) doc/running.pod > $(DESTDIR)$(MANDIR)/man1/parrot-net2pbc.1
	$(MKPATH) $(DESTDIR)$(DOC_DIR)/languages/$(LANG)
	$(CP) $(DOCS) $(DESTDIR)$(DOC_DIR)/languages/$(LANG)
	$(CP) doc/*.pod $(DESTDIR)$(DOC_DIR)/languages/$(LANG)
	$(MKPATH) $(DESTDIR)$(DOC_DIR)/languages/$(LANG)/constructs
	$(CP) doc/constructs/.pod $(DESTDIR)$(DOC_DIR)/languages/$(LANG)/constructs

# CLEANUP TARGETS
# ###############

CLEANERS = \
 "$(PMCDIR)/dotnet*.h" \
 "$(PMCDIR)/pmc_*.h" \
 "$(PMCDIR)/*_group.h" \
 "$(PMCDIR)/*$(LOAD_EXT)" \
 "$(PMCDIR)/*.dump" \
 "$(PMCDIR)/*.c" \
 "$(PMCDIR)/*$(O)" \
 "$(PMCDIR)/*.def" \
 "$(PMCDIR)/*.exp" \
 "$(PMCDIR)/*.pdb" \
 "$(PMCDIR)/*.ilk" \
 "$(PMCDIR)/*.lib" \
 "$(OPSDIR)/*.c" \
 "$(OPSDIR)/*.h" \
 "$(OPSDIR)/*$(O)" \
 "$(OPSDIR)/*$(LOAD_EXT)" \
 "$(OPSDIR)/*.exp" \
 "$(OPSDIR)/*.pdb" \
 "$(OPSDIR)/*.ilk" \
 "$(OPSDIR)/*.lib" \
 "*.pbc" \
 "*.dll" \
 "src/*.pbc" \
 src/it.pir \
 src/builtins.pir \
 net2pbc$(EXE) installable_net2pbc$(EXE)

clean:
	$(RM_F) $(CLEANERS)

realclean : clean
	$(RM_F) Makefile config/Makefile.tmp config/N2PConfig.pm
